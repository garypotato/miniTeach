# Project Specification

## Overview

This is a **Next.js 15** project designed to assist **parents** in finding suitable **companions** to look after their children. Every new companion needs to fill all the required fields and get approval from the support team, before being shown on the platform. **Parents** review companions and contact our support team to get the interested companion's contact details.

## Code Standards

- Use **Server-side Rendering (SSR)** and **server-side data fetching** as the default
- Use **client-side fetching** only when absolutely necessary
- Follow the **DRY (Don't Repeat Yourself)** principle: Reuse shared components and utilities before building new ones
- Prioritize **server components** over client components wherever possible

## Tech Stack

### Next.js 15:

- **Server Components**: Use server components as much as possible. Server components should always take higher priority than client components
- **Server Actions**: All Shopify API logic encapsulated in server actions within `lib/shopify/`
- **API Routes**: Only essential routes remain:
  - `/api/auth/[...nextauth]`: Required for Next-auth.js authentication
  - `/api/companion/login`: Provides login logic that Next-auth.js uses

### Shopify Integration

This project doesn't have its own database, but uses **Shopify** as the database. The Shopify store keys can be found in `.env`. Three main Shopify features are utilized:

#### Products

- One product represents `companion` or `resource`
- Products under collection `Companion` (collection_id: `491355177275`) are companions
- Products under collection `Resource` (collection_de: `492851167547`) are resource
- files and metafileds in product under different collection has different meanings(definitions)
- **Companion Product Fields:**
  - `title`: Automatically generated by combining metafields `first_name` and `last_name`
  - `id`: Unique identifier for a product
  - `images`: Profile images of the companion
- **Resource Product Fileds:**
  - `title`: The chapter of a resource (e.g. Direction and Position Recognition 3)
  - `id`: Unique Identifer for a resource
  - `images`: images of the resource

#### Collections

- **Companion Collection**: collection_id `491355177275`: Products under this collection are companions
- **Resource Collection**: collection_id `492851167547`: Products under this collection are companions

#### Metafields

##### Companion

All companion-specific data is stored in product metafields under the `custom` namespace:

- `user_name`: single line text - companion's login email address
- `password`: single line text - companion's login password (bcrypted)
- `first_name`: single line text - companion's first name
- `last_name`: single line text - companion's last name
- `wechat_id`: single line text - companion's WeChat ID
- `major`: single line text - companion's study major
- `education`: single line text (list) - education background
- `language`: single line text (list) - languages the companion can speak
- `age`: integer number - companion's age
- `age_range`: sinle line text - companion's age range
- `location`: single line text - current location (limited to: Sydney, Melbourne, Brisbane, Gold Coast, Adelaide)
- `age_group`: single line text (list) - children age groups the companion can handle
- `blue_card`: boolean - Blue Card/WWCC status
- `police_check`: boolean - Police check status
- `skill`: single line text (list) - relevant skills
- `certification`: single line text (list) - certifications including graduation certificates
- `availability`: single line text (list) - available times for jobs
- `description`: multiple line text - general description for a companion

##### Resource

All resource-specific data is stored in product metafields under the `custom` namespace:

- `last_name`: the name as a resource. (e.g. Direction and Position Recognition)
  Note: I make up a concept a book (group by `last_name`), a book will includes multiple resource products (you can imagine chapters in a book).

#### Shopify API Integration

**Tool**: `shopify-api-node` package with GraphQL for metafields

**Requirements**:

- ✅ **Encapsulate all Shopify API logic with server actions inside `lib/shopify/` folder**
- ✅ **No API routes for Shopify operations** (all logic moved to server actions)
- ✅ **Server actions list**: Available for review and reuse
- ✅ **GraphQL**: Product metafields fetched using GraphQL queries

**Server Actions Available:**

**Core Product Operations:**

- `getProducts()` - Fetch products with basic fields
- `getProductsWithMetafields()` - Fetch products with metafields via GraphQL
- `getProductWithMetafields()` - Fetch single product with metafields
- `createCompanionProduct()` - Create new companion product (supports images)
- `createProductMetafields()` - Create product metafields
- `addProductToCollection()` - Add product to collection
- `updateProductStatus()` - Update product status (active/draft/archived)
- `checkUserNameExists()` - Check email uniqueness via GraphQL

**High-Level Component Actions:**

- `checkEmailAvailability()` - Email validation wrapper
- `createCompanion()` - Complete companion creation flow (uses only server actions)

### Next-auth.js

Front-end authentication for Next.js with JWT strategy and 7-day session expiration.

## Project Structure

```
lib/                        # All shared utilities and logic
├── auth.ts                 # Authentication configuration
└── shopify/                # All Shopify logic (server actions only)
    ├── types.ts            # TypeScript interfaces
    ├── client.ts           # Shopify client configuration
    ├── products.ts         # Product-related server actions
    ├── metafields.ts       # Metafields processing utilities
    ├── utils.ts            # Utility functions (transformations)
    ├── companion-actions.ts # Companion-specific server actions
    └── index.ts            # Barrel exports

app/                        # Next.js app directory
├── page.tsx                # Home page (server component)
├── companions/page.tsx     # Companions listing (server component)
├── companion/
│   ├── [id]/page.tsx       # Companion detail (server component)
│   ├── login/page.tsx      # Login page (client component)
│   ├── create/             # Companion registration
│   └── dashboard/          # Protected dashboard area
├── api/                    # Essential API routes only
│   ├── auth/[...nextauth]/ # Next-auth.js required
│   └── companion/login/    # Authentication endpoint
└── actions/                # Page-specific server actions
    └── profile.ts          # Profile-related actions
```

## Pages Implementation Status

### `/` (Home Page) ✅ COMPLETED

- ✅ **Server Component**: Optimized SSR implementation
- ✅ **General Info**: Platform introduction and overview
- ✅ **Companion Showcase**: Lists selection of featured companions
- ✅ **Navigation**: Option to view more companions
- ✅ **Server-side Data**: Uses `getProducts()` server action
- ✅ **Performance**: Static generation with shuffled companion selection

**Technical Implementation:**

- Server-side data fetching with random companion selection
- Responsive design with hero section, features, and companion grid
- SEO optimized with proper metadata

### `/companions` ✅ COMPLETED

- ✅ **Server Component**: Full SSR implementation
- ✅ **Pagination**: Paginated list of all companions (8 per page)
- ✅ **Search Filter**: Real-time search functionality
- ✅ **City Filter**: Filter by five locations (Sydney, Melbourne, Brisbane, Gold Coast, Adelaide)
- ✅ **Advanced Search**: Searches title, description, tags, and metafields
- ✅ **Performance**: Server-side filtering and pagination

**Technical Implementation:**

- Uses `getProductsWithMetafields()` server action
- Client-side search with server-side data
- Responsive grid layout with companion cards
- URL-based pagination and search parameters

### `/companion/[id]` ✅ COMPLETED

- ✅ **Server Component**: Dynamic server-side rendering
- ✅ **Detailed Profile**: Complete companion information display
- ✅ **Metafields Display**: All companion metafields properly formatted
- ✅ **Image Gallery**: Profile photos with responsive layout
- ✅ **Contact Info**: Professional contact through support team

**Technical Implementation:**

- Uses `getProductWithMetafields()` server action
- Dynamic routing with product ID
- Rich metafields display with icons and formatting
- Error handling with 404 for missing companions

### `/companion/login` ✅ COMPLETED

- ✅ **Client Component**: Interactive login form
- ✅ **Authentication Logic**: Supports both standard login (`user_name`/`password`) and WeChat fallback
- ✅ **API Integration**: Uses `/api/companion/login` endpoint
- ✅ **Password Security**: Supports both bcrypt hashed passwords and plain text (legacy)
- ✅ **Next-auth.js Integration**: JWT handling with session management
- ✅ **Redirect Logic**: Redirects to `/companion/dashboard` after successful login
- ✅ **Public Route**: Accessible without authentication

**Implementation Details:**

- Uses `getProductsWithMetafields()` to fetch companion data via GraphQL
- JWT secret stored in `.env` as `JWT_SECRET`
- Session strategy: JWT with 7-day expiration
- Error handling with Chinese localized messages

### `/companion/create` ✅ COMPLETED

- ✅ **Client Component**: Interactive form with validation
- ✅ **Server Actions**: Uses `createCompanion()` and `checkEmailAvailability()`
- ✅ **Form Validation**: Real-time validation and error display
- ✅ **Email Uniqueness**: Real-time email availability checking
- ✅ **Image Upload**: Support for up to 5 profile images
- ✅ **Success/Error Handling**: Proper feedback with success redirect
- ✅ **Draft Status**: Created companions start as "draft" for review

**Technical Implementation:**

- Multi-step form with comprehensive validation
- Server actions for data submission (no API routes)
- Image processing and base64 encoding
- Automatic collection assignment and metafields creation
- Success state with automatic redirect to companions list

### `/companion/dashboard` ✅ COMPLETED

- ✅ **Client Component**: Dashboard layout with authentication
- ✅ **Protected Route**: JWT authentication required for access
- ✅ **Navigation**: Left sidebar with profile navigation
- ✅ **Auto-redirect**: Automatically redirects to profile page
- ✅ **Responsive Design**: Works on desktop and mobile

**Implementation Details:**

- Protected by companion layout with session validation
- Automatic redirect to `/companion/dashboard/profile`
- Branded header with MiniTeach logo and user info

### `/companion/dashboard/profile` ✅ COMPLETED

- ✅ **Server Component**: Optimized server-side rendering
- ✅ **Profile Display**: Comprehensive companion information using metafields
- ✅ **Data Source**: Displays all metafields plus Shopify product `body_html`
- ✅ **Protected Route**: JWT authentication required
- ✅ **Responsive Layout**: Grid-based layout with profile images
- ✅ **Login Credentials Modal**: Modal appears when companion lacks `user_name` or `password` metafields

**Features Implemented:**

- **Basic Information**: Name, email, major, location, age, WeChat ID
- **About Section**: Rich HTML content from `body_html`
- **Skills & Qualifications**: Education, languages, certifications, blue card status
- **Preferences**: Age groups, availability
- **Profile Images**: Grid display of uploaded photos
- **Login Credentials Modal**: Integrated with GlobalModal system for missing `user_name` or `password`
- **Error Handling**: User-friendly error messages in Chinese
- ✅ **Profile Edit Mode**: Edit button toggles edit mode with form fields matching create companion page layout

**Technical Implementation:**

- Server-side authentication with `getServerAuthSession()`
- Server action for data fetching (`getCompanionProfile()`)
- Server action for updating login credentials (`updateCompanionLoginCredentials()`)
- Server action for updating profile data (`updateCompanionProfile()`)
- Integrated GlobalModal system with click-outside-to-close functionality
- Password confirmation modal for secure profile updates
- Edit mode with form fields matching create companion page layout
- `wechat_id` field disabled for editing (security requirement)
- Smart metafield processing that properly handles all field types
- Email uniqueness validation during profile updates
- Type-safe with TypeScript interfaces
- Performance optimized server component

## Architecture Highlights

### Server-First Approach ✅

- **Server Components**: All main pages use server components by default
- **Server Actions**: 100% of Shopify operations use server actions (zero direct API calls)
- **Client Components**: Used only when necessary (forms, authentication, interactivity)
- **API Route Compliance**: No API routes for Shopify operations - all logic in `lib/shopify/`

### Performance Optimizations ✅

- **SSR by Default**: Fast initial page loads
- **Static Generation**: Home page pre-generated
- **Efficient Data Fetching**: GraphQL for metafields, REST for basic operations
- **Bundle Size**: Optimized with server components reducing client-side JavaScript

### Developer Experience ✅

- **TypeScript**: Full type safety throughout the project
- **Code Organization**: Clean separation of concerns
- **Reusable Components**: DRY principle followed
- **Server Actions**: Centralized and reusable Shopify logic

### Authentication & Security ✅

- **JWT Strategy**: Secure session management
- **Password Hashing**: bcrypt for password security
- **Protected Routes**: Server-side authentication checks
- **Environment Variables**: Secure configuration management

## Environment Variables

Required in `.env`:

```
# Shopify Configuration
SHOP_NAME=your-shop-name.myshopify.com
API_ACCESS_TOKEN=shpat_your_access_token_here
API_KEY=your_api_key_here
API_SECRET_KEY=your_api_secret_key_here

# Authentication
JWT_SECRET=your_jwt_secret_here
NEXTAUTH_SECRET=your_nextauth_secret_here

# Application
NODE_ENV=development
SERVER_URL=https://www.miniteach.org
```

## Deployment Status

✅ **Production Ready**: All features implemented and tested
✅ **Build Success**: No compilation errors
✅ **Lint Clean**: No ESLint warnings or errors
✅ **Type Safe**: Full TypeScript coverage
✅ **Server Actions**: All Shopify logic properly encapsulated
✅ **Performance**: Optimized bundle sizes and loading times
